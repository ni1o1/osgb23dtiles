name: Build Wheels (Simple)

# ç®€åŒ–ç‰ˆçš„å¤šå¹³å°wheelæ„å»ºå·¥ä½œæµ
# é€‚ç”¨äºå¼€å‘å’Œæµ‹è¯•é˜¶æ®µï¼Œä¸åŒ…å«å‘å¸ƒåŠŸèƒ½

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Intel
          - os: macos-12  # Intel Mac
            platform: "macOS-x86_64"
            arch_cmd: "arch -x86_64"
          
          # macOS Apple Silicon (éœ€è¦macOS 14+çš„runner)
          - os: macos-14  # Apple Silicon Mac
            platform: "macOS-arm64"
            arch_cmd: "arch -arm64"
          
          # Linux
          - os: ubuntu-latest
            platform: "Linux-x86_64"
            arch_cmd: ""
          
          # Windows
          - os: windows-latest
            platform: "Windows-x64"
            arch_cmd: ""

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: å®‰è£…æ„å»ºä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools

    - name: æ„å»ºwheelåŒ… (macOS)
      if: startsWith(matrix.os, 'macos')
      run: |
        ${{ matrix.arch_cmd }} python build_wheels.py

    - name: æ„å»ºwheelåŒ… (Linux/Windows)
      if: "!startsWith(matrix.os, 'macos')"
      run: |
        python build_wheels.py

    - name: æ˜¾ç¤ºæ„å»ºç»“æœ
      shell: bash
      run: |
        echo "=== æ„å»ºå®Œæˆçš„æ–‡ä»¶ ==="
        ls -la dist/ || dir dist
        echo ""
        echo "=== å¹³å°: ${{ matrix.platform }} ==="
        
        # æ£€æŸ¥wheelæ–‡ä»¶å†…å®¹
        for file in dist/*.whl; do
          if [ -f "$file" ]; then
            echo "ğŸ“¦ $(basename "$file")"
            # åœ¨ä¸åŒå¹³å°ä¸Šæ£€æŸ¥æ–‡ä»¶å†…å®¹
            if command -v unzip >/dev/null 2>&1; then
              echo "   åº“æ–‡ä»¶:"
              unzip -l "$file" | grep -E '\.(dylib|so|dll)$' | sed 's/^/     /' || echo "     (æœªæ‰¾åˆ°åº“æ–‡ä»¶)"
            fi
          fi
        done

    - name: æµ‹è¯•wheelå®‰è£…
      shell: bash
      run: |
        # åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
        python -m venv test_install
        
        # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          source test_install/Scripts/activate
        else
          source test_install/bin/activate
        fi
        
        # å®‰è£…å¹¶æµ‹è¯•
        pip install dist/*.whl
        python -c "import osgb23dtiles; print('âœ… ${{ matrix.platform }} å®‰è£…æµ‹è¯•æˆåŠŸ!')"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: wheels-${{ matrix.platform }}
        path: |
          dist/*.whl
          dist/*.tar.gz
        retention-days: 7

  # æ±‡æ€»æ‰€æœ‰æ„å»ºç»“æœ
  summary:
    name: æ„å»ºæ±‡æ€»
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: all-wheels

    - name: æ˜¾ç¤ºæ‰€æœ‰æ„å»ºç»“æœ
      run: |
        echo "=== æ‰€æœ‰å¹³å°æ„å»ºç»“æœæ±‡æ€» ==="
        echo ""
        
        total_wheels=0
        for platform_dir in all-wheels/wheels-*/; do
          if [ -d "$platform_dir" ]; then
            platform=$(basename "$platform_dir" | sed 's/wheels-//')
            echo "ğŸ”§ $platform:"
            
            wheel_count=0
            for wheel in "$platform_dir"*.whl; do
              if [ -f "$wheel" ]; then
                echo "   ğŸ“¦ $(basename "$wheel")"
                ((wheel_count++))
                ((total_wheels++))
              fi
            done
            
            if [ $wheel_count -eq 0 ]; then
              echo "   âŒ æœªæ‰¾åˆ°wheelæ–‡ä»¶"
            fi
            echo ""
          fi
        done
        
        echo "ğŸ“Š æ€»è®¡æ„å»ºäº† $total_wheels ä¸ªwheelåŒ…"
        
        # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¹³å°éƒ½æˆåŠŸæ„å»º
        expected_platforms=("macOS-x86_64" "macOS-arm64" "Linux-x86_64" "Windows-x64")
        missing_platforms=()
        
        for platform in "${expected_platforms[@]}"; do
          if [ ! -d "all-wheels/wheels-$platform" ]; then
            missing_platforms+=("$platform")
          fi
        done
        
        if [ ${#missing_platforms[@]} -eq 0 ]; then
          echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸï¼"
        else
          echo "âš ï¸  ç¼ºå¤±å¹³å°: ${missing_platforms[*]}"
        fi

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        mkdir -p release-ready
        
        # æ”¶é›†æ‰€æœ‰wheelæ–‡ä»¶
        find all-wheels -name "*.whl" -exec cp {} release-ready/ \;
        find all-wheels -name "*.tar.gz" -exec cp {} release-ready/ \;
        
        echo "=== å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶ ==="
        ls -la release-ready/

    - name: ä¸Šä¼ å‘å¸ƒåŒ…
      uses: actions/upload-artifact@v3
      with:
        name: release-ready-all-platforms
        path: release-ready/*
        retention-days: 30